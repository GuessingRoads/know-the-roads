<!DOCTYPE html>
<html>
<head>
  <title>Know The Roads</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; }

    .legend {
      background: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.5em;
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }

    #login-btn, #logout-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background: black;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      z-index: 1001;
    }

    #logout-btn { right: 130px; }

    #music-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1002;
    }

    #music-modal {
      position: absolute;
      top: 50px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 6px;
      z-index: 1003;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    #music-modal button {
      margin-top: 4px;
      min-width: 85px;
      padding: 5px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #888;
      background: #f8f8f8;
      cursor: pointer;
      text-align: center;
      box-sizing: border-box;
    }

    #guess-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 2px solid #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1005;
      display: none;
      text-align: center;
      animation: popupFadeIn 0.3s ease;
      width: 260px;
    }

    #guess-modal input {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    #guess-modal button {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      background-color: #333;
      color: white;
      cursor: pointer;
      margin: 4px;
    }

    @keyframes popupFadeIn {
      from { opacity: 0; transform: translate(-50%, -60%) scale(0.95); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="music-btn" title="Music Settings">🎵</div>
  <div id="music-modal">
    <button id="mute-btn">Mute</button>
    <button id="skip-btn">Skip Track</button>
  </div>

  <div class="legend" id="legend">
    <strong>Legend</strong><br>
    Black: Unguessed<br>
    Red: Incorrect<br>
    Orange: Hint Used<br>
    Gray: Correct<br>
    Yellow: Suffix Warning<br>
    Prismatic: Ultra-Hard Mode
  </div>

  <button id="login-btn">Login with Google</button>
  <button id="logout-btn">Logout</button>

  <div id="guess-modal">
    <input type="text" id="guess-input" placeholder="Enter road name" />
    <div>
      <button id="submit-guess">Submit</button>
      <button id="give-up">Give Up</button>
    </div>
    <div id="feedback-message" style="margin-top: 8px; font-size: 14px;"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    import { roadNameToIds } from './roadNameToIds.js';

    const supabase = createClient(
      'https://yulvzmznvnctgaiwuypb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bHZ6bXpudm5jdGdhaXd1eXBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNzEzNjMsImV4cCI6MjA2Nzg0NzM2M30.7LOh2rqTkdB4oNJuFTd5o9snzX9dA7AOkmt7y9prQgM'
    );

    const suffixMap = {
      st: 'street', ave: 'avenue', rd: 'road', blvd: 'boulevard', ln: 'lane',
      dr: 'drive', ct: 'court', cir: 'circle', hwy: 'highway', pkwy: 'parkway',
      ter: 'terrace', pl: 'place'
    };

    let nameToLayers = {}, guessedSegmentIds = new Set(), segmentStateMap = new Map();
    let currentGuessTarget = null, attemptMap = new Map(), currentUserId = null;

    // MUSIC
    let audioContext, sourceNode, musicBuffer, musicPlaying = false, isMuted = false;
    const musicBtn = document.getElementById('music-btn');
    const muteBtn = document.getElementById('mute-btn');
    const skipBtn = document.getElementById('skip-btn');
    const modal = document.getElementById('music-modal');

    musicBtn.onclick = () => {
      modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
    };

    muteBtn.onclick = () => {
      isMuted = !isMuted;
      muteBtn.innerText = isMuted ? 'Unmute' : 'Mute';
      isMuted ? stopLoop() : playLoop();
    };

    skipBtn.onclick = () => {
      stopLoop();
      playLoop();
    };

    async function loadMusic() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const response = await fetch('music/Lofi_1.wav');
      const arrayBuffer = await response.arrayBuffer();
      musicBuffer = await audioContext.decodeAudioData(arrayBuffer);
    }

    function playLoop() {
      if (!musicBuffer || isMuted) return;
      sourceNode = audioContext.createBufferSource();
      sourceNode.buffer = musicBuffer;
      sourceNode.connect(audioContext.destination);
      sourceNode.loop = true;
      sourceNode.start(0);
    }

    function stopLoop() {
      if (sourceNode) {
        sourceNode.stop(0);
        sourceNode.disconnect();
        sourceNode = null;
      }
    }

    window.addEventListener('click', async () => {
      if (!musicPlaying) {
        await loadMusic();
        playLoop();
        musicPlaying = true;
      }
    }, { once: true });

    // AUTH
    document.getElementById('login-btn').onclick = async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin }
      });
      if (error) alert('Login error: ' + error.message);
    };

    document.getElementById('logout-btn').onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    supabase.auth.onAuthStateChange((event, session) => {
      if (session?.user) {
        currentUserId = session.user.id;
        loadGuessedSegmentIds();
      }
    });

    async function loadGuessedSegmentIds() {
      const { data } = await supabase
        .from('road_guesses')
        .select('road_id, correct, used_hint')
        .eq('user_id', currentUserId);
      if (data) {
        data.forEach(row => {
          guessedSegmentIds.add(row.road_id);
          segmentStateMap.set(row.road_id, {
            correct: row.correct,
            used_hint: row.used_hint
          });
        });
      }
    }

    async function saveGuessSegmentIds(roadName, isCorrect, usedHint = false) {
      const ids = roadNameToIds[roadName] || [];
      for (const id of ids) {
        const existing = segmentStateMap.get(id);
        if (!existing) {
          await supabase.from('road_guesses').insert([{
            user_id: currentUserId,
            road_id: id,
            road_name: roadName,
            correct: isCorrect,
            used_hint: usedHint
          }]);
          guessedSegmentIds.add(id);
          segmentStateMap.set(id, { correct: isCorrect, used_hint: usedHint });
        } else if (isCorrect && !existing.correct) {
          await supabase
            .from('road_guesses')
            .update({ correct: true, used_hint: usedHint })
            .eq('user_id', currentUserId)
            .eq('road_id', id);
          segmentStateMap.set(id, { correct: true, used_hint: usedHint });
        }
      }
    }

    function applyColorToAllSegments(name, color) {
      if (!nameToLayers[name]) return;
      nameToLayers[name].forEach(layer => layer.setStyle({ color }));
    }

    function normalizeName(name) {
      const parts = name.trim().toLowerCase().split(" ");
      const last = parts[parts.length - 1];
      const suffix = suffixMap[last] || last;
      return [...parts.slice(0, -1), suffix].join(" ");
    }

    function suffixOnlyMismatch(guess, actual) {
      const g = guess.toLowerCase().split(" ");
      const a = actual.toLowerCase().split(" ");
      return g.length === a.length &&
             g.slice(0, -1).join(" ") === a.slice(0, -1).join(" ") &&
             g[g.length - 1] !== a[a.length - 1];
    }

    const guessModal = document.getElementById('guess-modal');
    const guessInput = document.getElementById('guess-input');
    const feedbackMessage = document.getElementById('feedback-message');

    function openGuessModal(targetName) {
      if (!targetName || guessedSegmentIds.has(roadNameToIds[targetName]?.[0])) return;
      currentGuessTarget = targetName;
      guessInput.value = '';
      feedbackMessage.innerText = '';
      guessModal.style.display = 'block';
      guessInput.focus();
    }

    function closeGuessModal() {
      guessModal.style.display = 'none';
    }

    document.getElementById('submit-guess').onclick = handleGuess;
    document.getElementById('give-up').onclick = async () => {
      if (!currentGuessTarget) return;
      applyColorToAllSegments(currentGuessTarget, 'orange');
      feedbackMessage.innerText = `Gave up! The road was: ${currentGuessTarget}`;
      await saveGuessSegmentIds(currentGuessTarget, true, true);
      guessedSegmentIds.add(roadNameToIds[currentGuessTarget]?.[0]);
      setTimeout(closeGuessModal, 1200);
    };

    guessInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') handleGuess();
    });

    async function handleGuess() {
      const input = guessInput.value.trim();
      const normalizedGuess = normalizeName(input);
      const normalizedActual = normalizeName(currentGuessTarget);
      const attempts = attemptMap.get(currentGuessTarget) || 0;

      if (!currentGuessTarget) return;

      if (normalizedGuess === normalizedActual) {
        const usedHint = attempts >= 3;
        applyColorToAllSegments(currentGuessTarget, usedHint ? 'orange' : 'gray');
        await saveGuessSegmentIds(currentGuessTarget, true, usedHint);
        guessedSegmentIds.add(roadNameToIds[currentGuessTarget]?.[0]);
        feedbackMessage.innerText = '✅ Correct!';
        setTimeout(closeGuessModal, 1000);
        return;
      }

      if (suffixOnlyMismatch(normalizedGuess, normalizedActual)) {
        applyColorToAllSegments(currentGuessTarget, 'yellow');
        feedbackMessage.innerText = 'Almost... check the suffix!';
        return;
      }

      const newAttempts = attempts + 1;
      attemptMap.set(currentGuessTarget, newAttempts);

      if (newAttempts >= 4) {
        const firstLetter = currentGuessTarget.charAt(0).toUpperCase();
        applyColorToAllSegments(currentGuessTarget, 'orange');
        await saveGuessSegmentIds(currentGuessTarget, true, true);
        guessedSegmentIds.add(roadNameToIds[currentGuessTarget]?.[0]);
        feedbackMessage.innerText = `Hint used! Road begins with ${firstLetter}`;
        setTimeout(closeGuessModal, 1500);
        return;
      }

      if (newAttempts === 1) {
        await saveGuessSegmentIds(currentGuessTarget, false, false);
      }

      applyColorToAllSegments(currentGuessTarget, 'red');
      feedbackMessage.innerText = '❌ Incorrect. Try again.';
    }

    const map = L.map('map', { zoomControl: false }).setView([40.09, -76.3], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    fetch('roads_manheim_named_only.geojson')
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          onEachFeature: function (feature, layer) {
            const id = String(feature.id);
            const name = feature.properties.name || "";
            if (!nameToLayers[name]) nameToLayers[name] = [];
            nameToLayers[name].push(layer);

            if (segmentStateMap.has(id)) {
              const state = segmentStateMap.get(id);
              const color = state.correct
                ? (state.used_hint ? 'orange' : 'gray')
                : 'red';
              layer.setStyle({ color, weight: 6 });
            } else {
              layer.setStyle({ color: 'black', weight: 6 });
            }

            layer.on('click', () => openGuessModal(name));
          }
        }).addTo(map);
      });
  </script>
</body>
</html>

